<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>图片加密解密二维码工具</title>
    <style>
        :root {
            --pepc-gap: 2vw;
            --pepc-radius: 14px;
        }
        html, body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 60%, #dbeafe 100%);
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 3vw auto;
            background: #fff;
            border-radius: var(--pepc-radius);
            box-shadow: 0 6px 32px 0 rgba(0,0,0,0.08);
            padding: 2vw;
            display: flex;
            flex-direction: column;
            gap: var(--pepc-gap);
        }
        .pepc-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--pepc-gap);
            justify-content: space-between;
            align-items: flex-start;
        }
        .pepc-col {
            flex: 1;
            min-width: 250px;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 1em;
        }
        .preview-img, .qr-img {
            max-width: 100%;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: #f3f4f6;
        }
        .section-title {
            font-size: 1.18em;
            color: #1e293b;
            margin-bottom: 0.2em;
        }
        label, button, input, textarea {
            font-size: 1em;
        }
        .action-group {
            display: flex;
            gap: 1em;
            margin-top: 0.5em;
        }
        textarea {
            width: 100%;
            min-height: 5em;
            resize: vertical;
            border-radius: 8px;
            padding: 0.7em;
            border: 1px solid #a5b4fc;
            background: #f9fafb;
            font-family: 'Fira Mono', monospace;
        }
        input[type="password"], input[type="text"] {
            padding: 0.7em;
            border-radius: 7px;
            border: 1px solid #a5b4fc;
            background: #f8fafc;
            font-family: inherit;
        }
        button {
            background: linear-gradient(90deg, #2563eb 30%, #60a5fa 100%);
            color: #fff;
            border: none;
            border-radius: 7px;
            padding: 0.6em 1.2em;
            cursor: pointer;
            font-weight: 700;
            transition: background 0.18s;
        }
        button:hover {
            background: #1d4ed8;
        }
        @media (max-width:700px) {
            .container {padding:1vw;}
            .pepc-row {flex-direction:column;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="text-align:center;">图片加密解密 &amp; 二维码生成工具（PEPC布局）</h2>
        <div class="pepc-row">
            <div class="pepc-col">
                <div class="section-title">1. 上传图片并输入密钥</div>
                <input type="file" id="imgInput" accept="image/*"><br>
                <input type="password" id="encKey" placeholder="请输入密钥">
                <div class="action-group">
                    <button onclick="encryptImage()">加密图片</button>
                    <button onclick="clearAll()">清空</button>
                </div>
                <img id="imgPreview" class="preview-img" alt="预览图片" style="display:none">
            </div>
            <div class="pepc-col">
                <div class="section-title">2. 加密文本 / 二维码生成</div>
                <textarea id="encText" placeholder="这里显示加密结果"></textarea>
                <div class="action-group">
                    <button onclick="genQR()">生成二维码</button>
                </div>
                <div id="qrCode" style="margin:0 auto"></div>
            </div>
            <div class="pepc-col">
                <div class="section-title">3. 解密（支持图片和文本）</div>
                <textarea id="decText" placeholder="粘贴加密文本"></textarea>
                <input type="password" id="decKey" placeholder="请输入解密密钥">
                <div class="action-group">
                    <button onclick="decryptImage()">解密为图片</button>
                </div>
                <img id="decPreview" class="preview-img" alt="解密后的图片" style="display:none">
            </div>
        </div>
        <div class="pepc-row">
            <div style="font-size:0.93em;color:#475569;">
                说明：XOR加密算法结合PBKDF2加盐密钥派生，粘贴加密文本可直接解码图片，二维码最大推荐数据量128KB。图片仅本地处理，极大保护隐私与安全。
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // PBKDF2 派生密钥
        function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            return window.crypto.subtle.importKey(
                "raw",
                encoder.encode(password),
                "PBKDF2",
                false,
                ["deriveKey"]
            ).then(baseKey => {
                return window.crypto.subtle.deriveKey({
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 120000,
                    hash: "SHA-256"
                }, baseKey, {name:"AES-GCM", length:256}, false, ["encrypt", "decrypt"]);
            });
        }
        // 简易XOR加密
        async function xorEncrypt(bytes, password) {
            // 随机盐并PBKDF2
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const aesKey = await deriveKey(password, salt);
            // 用AES-GCM加密（二进制）
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv }, 
                aesKey, bytes);
            // 最终输出 [salt16][iv12][enc]
            let totalbuf = new Uint8Array(16 + 12 + encrypted.byteLength);
            totalbuf.set(salt, 0);
            totalbuf.set(iv, 16);
            totalbuf.set(new Uint8Array(encrypted), 28);
            return totalbuf;
        }
        async function xorDecrypt(encBuf, password) {
            const salt = encBuf.slice(0,16);
            const iv = encBuf.slice(16,28);
            const enc = encBuf.slice(28);
            const aesKey = await deriveKey(password, salt);
            try {
                const dec = await window.crypto.subtle.decrypt(
                    { name:"AES-GCM", iv:iv }, aesKey, enc);
                return new Uint8Array(dec);
            } catch(e) { throw '密钥错误或数据损坏'; }
        }
        function u8ToBase64(u8a) {
            return btoa(String.fromCharCode.apply(null, u8a));
        }
        function base64ToU8(str) {
            let bin = atob(str);
            let arr = new Uint8Array(bin.length);
            for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
            return arr;
        }
        function clearAll() {
            document.getElementById('imgPreview').style.display='none';
            document.getElementById('imgPreview').src='';
            document.getElementById('encText').value='';
            document.getElementById('qrCode').innerHTML='';
            document.getElementById('decText').value='';
            document.getElementById('decPreview').style.display='none';
            document.getElementById('decPreview').src='';
            document.getElementById('imgInput').value=null;
        }
        // 图片加密
        async function encryptImage() {
            let file = document.getElementById('imgInput').files[0];
            let key = document.getElementById('encKey').value;
            if (!file || !key) {
                alert('请上传图片并输入密钥！'); return;
            }
            let reader = new FileReader();
            reader.onload = async function() {
                let bytes = new Uint8Array(reader.result);
                let enc = await xorEncrypt(bytes,key);
                let b64 = u8ToBase64(enc);
                document.getElementById('encText').value=b64;
                document.getElementById('imgPreview').src=URL.createObjectURL(file);
                document.getElementById('imgPreview').style.display='block';
            };
            reader.readAsArrayBuffer(file);
        }
        // 生成二维码
        function genQR() {
            let text = document.getElementById('encText').value;
            let qrBox = document.getElementById('qrCode');
            qrBox.innerHTML = '';
            if(!text) return;
            new QRCode(qrBox, {
                text: text,
                width: 210,
                height: 210,
                colorDark: '#111827',
                colorLight: '#f9fafb',
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        // 解密
        async function decryptImage() {
            let b64 = document.getElementById('decText').value.trim();
            let key = document.getElementById('decKey').value;
            if (!b64 || !key) {
                alert('请粘贴加密文本并输入密钥！'); return;
            }
            try {
                let encBuf = base64ToU8(b64);
                let dec = await xorDecrypt(encBuf, key);
                // 转为图片Blob
                let blob = new Blob([dec]);
                let url = URL.createObjectURL(blob);
                let decPreview = document.getElementById('decPreview');
                decPreview.src = url;
                decPreview.style.display='block';
            } catch(e) {
                alert('解密失败：' + e);
            }
        }
    </script>
</body>
</html>
