<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>图片加密 · Picocrypt样式</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      margin:0;
      font-family:'Segoe UI',Arial,sans-serif;
      background: #f6faff;
      color: #0d3879;
    }
    .container {
      max-width:420px;
      margin:40px auto 0 auto;
      background:#fff;
      box-shadow:0 2px 16px #d7e8ff55;
      border-radius:24px;
      padding:32px 18px 28px 18px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    h2 {
      text-align:center;
      color:#065ada;
      letter-spacing:1.2px;
    }
    input,button {
      outline:none;
      box-sizing:border-box;
      border-radius:5px;
      border:1px solid #d7e8ff;
      padding:12px;
      font-size:1rem;
      width:100%;
      margin-bottom:10px;
      background:#eef6ff;
      transition:.2s;
    }
    input:focus,button:active {
      border-color:#067afd;
    }
    button {
      background:#067afd;
      color:#fff;
      font-weight: bold;
      cursor:pointer;
      margin-bottom:0;
    }
    .result {
      background:#eef6ff;
      word-break:break-all;
      font-size:0.96em;
      padding:14px;
      border-radius:7px;
      min-height:48px;
      color:#0d3879;
      margin:6px 0;
    }
    @media (max-width:480px){
      .container {width:96vw;padding:22px 6vw;}
    }
  </style>
</head>
<body>
<div class="container">
  <h2>图片加密工具</h2>
  <input type="file" id="imgFile" accept="image/*">
  <input type="password" id="pass" placeholder="输入加密密码">
  <button onclick="encryptImage()">加密并下载</button>
  <div id="msg" class="result"></div>
</div>
<script>
function str2ab(str){
  let buf=new ArrayBuffer(str.length),bufView=new Uint8Array(buf);
  for(let i=0;i<str.length;i++)bufView[i]=str.charCodeAt(i);
  return buf;
}
async function encryptData(buffer, password){
  const enc=new TextEncoder();
  const keyMaterial=await window.crypto.subtle.importKey(
    "raw",enc.encode(password),"PBKDF2",false,["deriveKey"]
  );
  const salt=window.crypto.getRandomValues(new Uint8Array(16));
  const key=await window.crypto.subtle.deriveKey(
    {name:"PBKDF2",salt:salt,iterations:2048,hash:"SHA-256"},
    keyMaterial,{name:"AES-GCM",length:256},false,["encrypt"]
  );
  const iv=window.crypto.getRandomValues(new Uint8Array(12));
  const encrypted=await window.crypto.subtle.encrypt(
    {name:"AES-GCM",iv:iv},
    key,buffer
  );
  let total=new Uint8Array(salt.length+iv.length+encrypted.byteLength);
  total.set(salt,0);
  total.set(iv,salt.length);
  total.set(new Uint8Array(encrypted),salt.length+iv.length);
  return total;
}
function encryptImage(){
  let file=document.getElementById('imgFile').files[0];
  let password=document.getElementById('pass').value;
  let msg=document.getElementById('msg');
  msg.textContent='';
  if(!file){msg.textContent="请选择图片";return;}
  if(!password){msg.textContent="请填写密码";return;}
  let reader=new FileReader();
  reader.onload=async function(e){
    try{
      let buf=e.target.result;
      let enc=await encryptData(buf,password);
      let blob=new Blob([enc],{type:"application/octet-stream"});
      let a=document.createElement('a');
      a.download=file.name+'.enc.txt';
      a.href=URL.createObjectURL(blob);
      a.style.display="none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      msg.textContent="加密完成，已下载。";
    }catch(err){
      msg.textContent="加密失败："+err;
    }
  }
  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
