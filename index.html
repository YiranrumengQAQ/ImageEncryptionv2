<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ç‰‡åŠ å¯†è§£å¯†å·¥å…· Â· Picocryptæ ·å¼</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family:'Segoe UI',Tahoma,sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #f6faff 100%);
      color: #0d3879;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .container {
      max-width:900px;
      width:100%;
      background:#fff;
      box-shadow:0 8px 32px rgba(6,122,253,0.15);
      border-radius:20px;
      padding:40px 36px;
    }
    h1 {
      text-align:center;
      color:#067afd;
      font-size:2em;
      margin:0 0 8px 0;
      letter-spacing:0.5px;
    }
    .subtitle {
      text-align:center;
      color:#5a8cc7;
      font-size:0.95em;
      margin:0 0 32px 0;
    }
    .tab-buttons {
      display:flex;
      gap:10px;
      margin-bottom:28px;
    }
    .tab-btn {
      flex:1;
      padding:14px;
      border:none;
      background:#e3f2fd;
      color:#067afd;
      font-weight:600;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s;
      font-size:1em;
    }
    .tab-btn.active {
      background:linear-gradient(135deg, #067afd 0%, #0561d4 100%);
      color:#fff;
      box-shadow:0 4px 12px rgba(6,122,253,0.4);
      transform:translateY(-2px);
    }
    .tab-btn:hover:not(.active) {
      background:#cce7ff;
      transform:translateY(-1px);
    }
    .tab-content {
      display:none;
    }
    .tab-content.active {
      display:block;
    }
    
    /* åŒæ å¸ƒå±€ */
    .content-wrapper {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:24px;
      margin-bottom:20px;
    }
    
    /* å·¦ä¾§è¡¨å•åŒºåŸŸ */
    .form-section {
      display:flex;
      flex-direction:column;
    }
    
    .form-group {
      margin-bottom:18px;
    }
    label {
      display:block;
      margin-bottom:8px;
      color:#0d3879;
      font-weight:600;
      font-size:0.95em;
    }
    input[type="file"], input[type="password"], input[type="text"] {
      width:100%;
      padding:13px 16px;
      border:2px solid #d7e8ff;
      border-radius:10px;
      font-size:0.95em;
      background:#f9fcff;
      transition:all 0.3s;
      color:#0d3879;
    }
    input[type="file"]:focus, input[type="password"]:focus, input[type="text"]:focus {
      outline:none;
      border-color:#067afd;
      background:#fff;
      box-shadow:0 0 0 3px rgba(6,122,253,0.1);
    }
    input[type="password"]::placeholder, input[type="text"]::placeholder {
      color:#9ec5ed;
    }
    
    /* å³ä¾§é¢„è§ˆåŒºåŸŸ */
    .preview-section {
      display:flex;
      flex-direction:column;
    }
    .preview-label {
      margin-bottom:8px;
      color:#0d3879;
      font-weight:600;
      font-size:0.95em;
    }
    .preview-container {
      flex:1;
      border:2px dashed #d7e8ff;
      border-radius:10px;
      background:#f9fcff;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:280px;
      position:relative;
      overflow:hidden;
      transition:all 0.3s;
    }
    .preview-container.has-image {
      border-style:solid;
      border-color:#067afd;
      background:#fff;
    }
    .preview-placeholder {
      text-align:center;
      color:#9ec5ed;
      font-size:0.9em;
      padding:20px;
    }
    .preview-placeholder svg {
      width:64px;
      height:64px;
      margin-bottom:12px;
      opacity:0.3;
    }
    .preview-image {
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      display:none;
    }
    .preview-image.show {
      display:block;
    }
    
    /* åŠ å¯†çŠ¶æ€æ ‡è®° */
    .encrypted-badge {
      position:absolute;
      top:12px;
      right:12px;
      background:linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color:#fff;
      padding:6px 14px;
      border-radius:20px;
      font-size:0.8em;
      font-weight:700;
      box-shadow:0 2px 8px rgba(255,107,107,0.4);
      display:none;
      animation:pulse 2s infinite;
    }
    .encrypted-badge.show {
      display:block;
    }
    @keyframes pulse {
      0%, 100% { transform:scale(1); }
      50% { transform:scale(1.05); }
    }
    
    /* åŠ å¯†çŠ¶æ€é®ç½© */
    .encrypted-overlay {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      backdrop-filter:blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      color:#fff;
    }
    .encrypted-overlay.show {
      display:flex;
    }
    .encrypted-overlay svg {
      width:80px;
      height:80px;
      margin-bottom:16px;
      animation:float 3s ease-in-out infinite;
    }
    .encrypted-overlay p {
      font-size:1.1em;
      font-weight:600;
      margin:0;
    }
    @keyframes float {
      0%, 100% { transform:translateY(0); }
      50% { transform:translateY(-10px); }
    }
    
    .btn {
      width:100%;
      padding:16px;
      border:none;
      background:linear-gradient(135deg, #067afd 0%, #0561d4 100%);
      color:#fff;
      font-weight:700;
      font-size:1.05em;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s;
      margin-top:auto;
      letter-spacing:0.5px;
      box-shadow:0 4px 12px rgba(6,122,253,0.3);
    }
    .btn:hover {
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(6,122,253,0.4);
    }
    .btn:active {
      transform:translateY(0);
    }
    .msg {
      margin-top:20px;
      padding:16px;
      border-radius:10px;
      font-size:0.95em;
      display:none;
      animation:slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity:0; transform:translateY(-10px); }
      to { opacity:1; transform:translateY(0); }
    }
    .msg.show {
      display:block;
    }
    .msg.success {
      background:#e8f5e9;
      color:#2e7d32;
      border-left:4px solid #4caf50;
    }
    .msg.error {
      background:#ffebee;
      color:#c62828;
      border-left:4px solid #f44336;
    }
    .msg.info {
      background:#e3f2fd;
      color:#1565c0;
      border-left:4px solid #2196f3;
    }
    .footer {
      text-align:center;
      margin-top:28px;
      color:#7ba3d1;
      font-size:0.9em;
      padding-top:20px;
      border-top:1px solid #e3f2fd;
    }
    
    @media (max-width:768px){
      .content-wrapper {
        grid-template-columns:1fr;
      }
      .container {
        padding:32px 24px;
      }
      h1 {
        font-size:1.6em;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ” å›¾ç‰‡åŠ å¯†å·¥å…·</h1>
  <p class="subtitle">åŸºäºXChaCha20-Poly1305åŠ å¯†ç®—æ³• Â· æœ¬åœ°åŠ å¯† Â· å®‰å…¨å¯é </p>

  <div class="tab-buttons">
    <button class="tab-btn active" onclick="switchTab('encrypt')">ğŸ”’ åŠ å¯†å›¾ç‰‡</button>
    <button class="tab-btn" onclick="switchTab('decrypt')">ğŸ”“ è§£å¯†å›¾ç‰‡</button>
  </div>

  <!-- åŠ å¯†æ ‡ç­¾é¡µ -->
  <div id="encrypt-tab" class="tab-content active">
    <div class="content-wrapper">
      <!-- å·¦ä¾§è¡¨å• -->
      <div class="form-section">
        <div class="form-group">
          <label>ğŸ“ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
          <input type="file" id="encFile" accept="image/*" onchange="previewEncryptImage(this)">
        </div>
        <div class="form-group">
          <label>ğŸ”‘ è®¾ç½®å¯†ç </label>
          <input type="password" id="encPass" placeholder="è¯·è¾“å…¥å¼ºå¯†ç (è‡³å°‘6ä½)">
        </div>
        <button class="btn" onclick="encryptFile()">ğŸ”’ åŠ å¯†å¹¶ä¸‹è½½</button>
      </div>
      
      <!-- å³ä¾§é¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-label">ğŸ“· åŸå›¾é¢„è§ˆ</div>
        <div class="preview-container" id="encPreview">
          <div class="preview-placeholder">
            <svg fill="#9ec5ed" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            <p>é€‰æ‹©å›¾ç‰‡åå°†æ˜¾ç¤ºé¢„è§ˆ</p>
          </div>
          <img id="encPreviewImg" class="preview-image" alt="åŸå›¾é¢„è§ˆ">
        </div>
      </div>
    </div>
  </div>

  <!-- è§£å¯†æ ‡ç­¾é¡µ -->
  <div id="decrypt-tab" class="tab-content">
    <div class="content-wrapper">
      <!-- å·¦ä¾§è¡¨å• -->
      <div class="form-section">
        <div class="form-group">
          <label>ğŸ“ é€‰æ‹©åŠ å¯†æ–‡ä»¶</label>
          <input type="file" id="decFile" onchange="previewDecryptFile(this)">
        </div>
        <div class="form-group">
          <label>ğŸ”‘ è¾“å…¥å¯†ç </label>
          <input type="password" id="decPass" placeholder="è¯·è¾“å…¥åŠ å¯†æ—¶çš„å¯†ç ">
        </div>
        <button class="btn" onclick="decryptFile()">ğŸ”“ è§£å¯†å¹¶ä¸‹è½½</button>
      </div>
      
      <!-- å³ä¾§é¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-label">ğŸ”’ æ–‡ä»¶é¢„è§ˆ</div>
        <div class="preview-container" id="decPreview">
          <div class="preview-placeholder">
            <svg fill="#9ec5ed" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <p>é€‰æ‹©æ–‡ä»¶åå°†æ˜¾ç¤ºçŠ¶æ€</p>
          </div>
          <div class="encrypted-overlay" id="encryptedOverlay">
            <svg fill="#fff" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <p>ğŸ” åŠ å¯†æ–‡ä»¶</p>
            <p style="font-size:0.85em;margin-top:8px;opacity:0.8;">è¾“å…¥å¯†ç åå¯è§£å¯†æŸ¥çœ‹</p>
          </div>
          <div class="encrypted-badge" id="encryptedBadge">ğŸ” å·²åŠ å¯†</div>
        </div>
      </div>
    </div>
  </div>

  <div id="msg" class="msg"></div>

  <div class="footer">
    ğŸ›¡ï¸ å®‰å…¨åŠ å¯† Â· ğŸ’» æœ¬åœ°å¤„ç† Â· ğŸš« æ•°æ®ä¸ä¸Šä¼  Â· âš¡ å¿«é€Ÿä¾¿æ·
  </div>
</div>

<script type="module">
// å¯¼å…¥åŠ å¯†åº“
import { XChaCha20Poly1305 } from 'https://cdn.jsdelivr.net/npm/@stablelib/xchacha20poly1305@1.0.1/+esm';
import { randomBytes } from 'https://cdn.jsdelivr.net/npm/@stablelib/random@1.0.2/+esm';

// æš´éœ²åˆ°å…¨å±€
window.XChaCha20Poly1305 = XChaCha20Poly1305;
window.randomBytes = randomBytes;
window.cryptoLoaded = true;
</script>

<script>
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

  if(tab === 'encrypt') {
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('encrypt-tab').classList.add('active');
  } else {
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('decrypt-tab').classList.add('active');
  }
  hideMsg();
  resetPreviews();
}

function resetPreviews() {
  // é‡ç½®åŠ å¯†é¢„è§ˆ
  document.getElementById('encPreview').classList.remove('has-image');
  document.getElementById('encPreviewImg').classList.remove('show');
  document.getElementById('encPreviewImg').src = '';
  
  // é‡ç½®è§£å¯†é¢„è§ˆ
  document.getElementById('decPreview').classList.remove('has-image');
  document.getElementById('encryptedOverlay').classList.remove('show');
  document.getElementById('encryptedBadge').classList.remove('show');
}

function previewEncryptImage(input) {
  const file = input.files[0];
  if(file && file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById('encPreviewImg');
      const container = document.getElementById('encPreview');
      img.src = e.target.result;
      img.classList.add('show');
      container.classList.add('has-image');
    };
    reader.readAsDataURL(file);
  }
}

function previewDecryptFile(input) {
  const file = input.files[0];
  if(file) {
    const container = document.getElementById('decPreview');
    const overlay = document.getElementById('encryptedOverlay');
    const badge = document.getElementById('encryptedBadge');
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯åŠ å¯†æ–‡ä»¶ï¼ˆé€šå¸¸ä»¥.encryptedç»“å°¾ï¼‰
    if(file.name.endsWith('.encrypted')) {
      container.classList.add('has-image');
      overlay.classList.add('show');
      badge.classList.add('show');
    } else {
      // å¦‚æœä¸æ˜¯æ ‡å‡†åŠ å¯†æ–‡ä»¶ï¼Œå°è¯•è¯»å–æ£€æŸ¥
      checkIfEncrypted(file).then(isEncrypted => {
        if(isEncrypted) {
          container.classList.add('has-image');
          overlay.classList.add('show');
          badge.classList.add('show');
        }
      });
    }
  }
}

async function checkIfEncrypted(file) {
  // ç®€å•æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯èƒ½æ˜¯åŠ å¯†æ–‡ä»¶
  try {
    const data = await file.slice(0, 100).arrayBuffer();
    const dataArray = new Uint8Array(data);
    // æ£€æŸ¥æ–‡ä»¶é•¿åº¦å’ŒåŸºæœ¬ç»“æ„
    return file.size >= 56 && dataArray.length >= 56;
  } catch(e) {
    return false;
  }
}

function showMsg(text, type) {
  const msg = document.getElementById('msg');
  msg.textContent = text;
  msg.className = 'msg show ' + type;
}

function hideMsg() {
  document.getElementById('msg').className = 'msg';
}

async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    enc.encode(password),
    'PBKDF2',
    false,
    ['deriveBits']
  );

  const bits = await crypto.subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: salt,
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    256
  );

  return new Uint8Array(bits);
}

async function encryptFile() {
  const file = document.getElementById('encFile').files[0];
  const password = document.getElementById('encPass').value;

  hideMsg();

  if(!file) {
    showMsg('âŒ è¯·é€‰æ‹©è¦åŠ å¯†çš„å›¾ç‰‡æ–‡ä»¶', 'error');
    return;
  }

  if(!password || password.length < 6) {
    showMsg('âŒ å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦', 'error');
    return;
  }

  if(!window.cryptoLoaded) {
    showMsg('â³ åŠ å¯†åº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™é‡è¯•...', 'error');
    return;
  }

  showMsg('â³ æ­£åœ¨åŠ å¯†ï¼Œè¯·ç¨å€™...', 'info');

  try {
    const data = await file.arrayBuffer();
    const salt = randomBytes(32);
    const nonce = randomBytes(24);
    const key = await deriveKey(password, salt);

    const cipher = new XChaCha20Poly1305(key);
    const encrypted = cipher.seal(nonce, new Uint8Array(data));

    const output = new Uint8Array(salt.length + nonce.length + encrypted.length);
    output.set(salt, 0);
    output.set(nonce, 32);
    output.set(encrypted, 56);

    const blob = new Blob([output], {type: 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = file.name + '.encrypted';
    a.click();
    URL.revokeObjectURL(url);

    showMsg('âœ… åŠ å¯†æˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½', 'success');
  } catch(err) {
    showMsg('âŒ åŠ å¯†å¤±è´¥: ' + err.message, 'error');
    console.error(err);
  }
}

async function decryptFile() {
  const file = document.getElementById('decFile').files[0];
  const password = document.getElementById('decPass').value;

  hideMsg();

  if(!file) {
    showMsg('âŒ è¯·é€‰æ‹©è¦è§£å¯†çš„æ–‡ä»¶', 'error');
    return;
  }

  if(!password) {
    showMsg('âŒ è¯·è¾“å…¥å¯†ç ', 'error');
    return;
  }

  if(!window.cryptoLoaded) {
    showMsg('â³ åŠ å¯†åº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™é‡è¯•...', 'error');
    return;
  }

  showMsg('â³ æ­£åœ¨è§£å¯†ï¼Œè¯·ç¨å€™...', 'info');

  try {
    const data = await file.arrayBuffer();
    const dataArray = new Uint8Array(data);

    if(dataArray.length < 56) {
      throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
    }

    const salt = dataArray.slice(0, 32);
    const nonce = dataArray.slice(32, 56);
    const encrypted = dataArray.slice(56);

    const key = await deriveKey(password, salt);
    const cipher = new XChaCha20Poly1305(key);

    const decrypted = cipher.open(nonce, encrypted);

    if(!decrypted) {
      throw new Error('å¯†ç é”™è¯¯æˆ–æ–‡ä»¶å·²æŸå');
    }

    let filename = file.name;
    if(filename.endsWith('.encrypted')) {
      filename = filename.slice(0, -10);
    } else {
      filename = 'decrypted_' + filename;
    }

    const blob = new Blob([decrypted], {type: 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);

    showMsg('âœ… è§£å¯†æˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½', 'success');
  } catch(err) {
    showMsg('âŒ è§£å¯†å¤±è´¥: ' + err.message, 'error');
    console.error(err);
  }
}

// æš´éœ²å‡½æ•°åˆ°å…¨å±€
window.switchTab = switchTab;
window.encryptFile = encryptFile;
window.decryptFile = decryptFile;
window.previewEncryptImage = previewEncryptImage;
window.previewDecryptFile = previewDecryptFile;
</script>
</body>
</html>
