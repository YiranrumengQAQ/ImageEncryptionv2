<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ç‰‡åŠ å¯†è§£å¯†å·¥å…· Â· Picocryptæ ·å¼</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family:'Segoe UI',Tahoma,sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #f6faff 100%);
      color: #0d3879;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .container {
      max-width:480px;
      width:100%;
      background:#fff;
      box-shadow:0 4px 24px rgba(6,122,253,0.12);
      border-radius:16px;
      padding:36px 32px;
    }
    h1 {
      text-align:center;
      color:#067afd;
      font-size:1.8em;
      margin:0 0 8px 0;
      letter-spacing:0.5px;
    }
    .subtitle {
      text-align:center;
      color:#5a8cc7;
      font-size:0.9em;
      margin:0 0 28px 0;
    }
    .tab-buttons {
      display:flex;
      gap:8px;
      margin-bottom:24px;
    }
    .tab-btn {
      flex:1;
      padding:12px;
      border:none;
      background:#e3f2fd;
      color:#067afd;
      font-weight:600;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s;
      font-size:0.95em;
    }
    .tab-btn.active {
      background:#067afd;
      color:#fff;
      box-shadow:0 2px 8px rgba(6,122,253,0.3);
    }
    .tab-btn:hover:not(.active) {
      background:#cce7ff;
    }
    .tab-content {
      display:none;
    }
    .tab-content.active {
      display:block;
    }
    .form-group {
      margin-bottom:16px;
    }
    label {
      display:block;
      margin-bottom:6px;
      color:#0d3879;
      font-weight:500;
      font-size:0.92em;
    }
    input[type="file"], input[type="password"], input[type="text"] {
      width:100%;
      padding:12px 14px;
      border:2px solid #d7e8ff;
      border-radius:8px;
      font-size:0.95em;
      background:#f9fcff;
      transition:all 0.2s;
      color:#0d3879;
    }
    input[type="file"]:focus, input[type="password"]:focus, input[type="text"]:focus {
      outline:none;
      border-color:#067afd;
      background:#fff;
    }
    input[type="password"]::placeholder, input[type="text"]::placeholder {
      color:#9ec5ed;
    }
    .btn {
      width:100%;
      padding:14px;
      border:none;
      background:linear-gradient(135deg, #067afd 0%, #0561d4 100%);
      color:#fff;
      font-weight:700;
      font-size:1em;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s;
      margin-top:8px;
      letter-spacing:0.3px;
    }
    .btn:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 16px rgba(6,122,253,0.35);
    }
    .btn:active {
      transform:translateY(0);
    }
    .msg {
      margin-top:18px;
      padding:14px;
      border-radius:8px;
      font-size:0.9em;
      display:none;
      animation:slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity:0; transform:translateY(-10px); }
      to { opacity:1; transform:translateY(0); }
    }
    .msg.show {
      display:block;
    }
    .msg.success {
      background:#e8f5e9;
      color:#2e7d32;
      border-left:4px solid #4caf50;
    }
    .msg.error {
      background:#ffebee;
      color:#c62828;
      border-left:4px solid #f44336;
    }
    .msg.info {
      background:#e3f2fd;
      color:#1565c0;
      border-left:4px solid #2196f3;
    }
    .footer {
      text-align:center;
      margin-top:24px;
      color:#7ba3d1;
      font-size:0.85em;
    }
    @media (max-width:520px){
      .container {
        padding:28px 20px;
      }
      h1 {
        font-size:1.5em;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ” å›¾ç‰‡åŠ å¯†å·¥å…·</h1>
  <p class="subtitle">åŸºäºXChaCha20-Poly1305åŠ å¯†ç®—æ³•</p>

  <div class="tab-buttons">
    <button class="tab-btn active" onclick="switchTab('encrypt')">åŠ å¯†</button>
    <button class="tab-btn" onclick="switchTab('decrypt')">è§£å¯†</button>
  </div>

  <!-- åŠ å¯†æ ‡ç­¾é¡µ -->
  <div id="encrypt-tab" class="tab-content active">
    <div class="form-group">
      <label>é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
      <input type="file" id="encFile" accept="image/*">
    </div>
    <div class="form-group">
      <label>è®¾ç½®å¯†ç </label>
      <input type="password" id="encPass" placeholder="è¯·è¾“å…¥å¼ºå¯†ç ">
    </div>
    <button class="btn" onclick="encryptFile()">ğŸ”’ åŠ å¯†å¹¶ä¸‹è½½</button>
  </div>

  <!-- è§£å¯†æ ‡ç­¾é¡µ -->
  <div id="decrypt-tab" class="tab-content">
    <div class="form-group">
      <label>é€‰æ‹©åŠ å¯†æ–‡ä»¶</label>
      <input type="file" id="decFile">
    </div>
    <div class="form-group">
      <label>è¾“å…¥å¯†ç </label>
      <input type="password" id="decPass" placeholder="è¯·è¾“å…¥åŠ å¯†æ—¶çš„å¯†ç ">
    </div>
    <button class="btn" onclick="decryptFile()">ğŸ”“ è§£å¯†å¹¶ä¸‹è½½</button>
  </div>

  <div id="msg" class="msg"></div>

  <div class="footer">
    å®‰å…¨ Â· ç®€æ´ Â· æœ¬åœ°åŠ å¯† Â· æ•°æ®ä¸ä¸Šä¼ 
  </div>
</div>

<script type="module">
// å¯¼å…¥åŠ å¯†åº“
import { XChaCha20Poly1305 } from 'https://cdn.jsdelivr.net/npm/@stablelib/xchacha20poly1305@1.0.1/+esm';
import { randomBytes } from 'https://cdn.jsdelivr.net/npm/@stablelib/random@1.0.2/+esm';

// æš´éœ²åˆ°å…¨å±€
window.XChaCha20Poly1305 = XChaCha20Poly1305;
window.randomBytes = randomBytes;
window.cryptoLoaded = true;
</script>

<script>
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

  if(tab === 'encrypt') {
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('encrypt-tab').classList.add('active');
  } else {
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('decrypt-tab').classList.add('active');
  }
  hideMsg();
}

function showMsg(text, type) {
  const msg = document.getElementById('msg');
  msg.textContent = text;
  msg.className = 'msg show ' + type;
}

function hideMsg() {
  document.getElementById('msg').className = 'msg';
}

async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    enc.encode(password),
    'PBKDF2',
    false,
    ['deriveBits']
  );

  const bits = await crypto.subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: salt,
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    256
  );

  return new Uint8Array(bits);
}

async function encryptFile() {
  const file = document.getElementById('encFile').files[0];
  const password = document.getElementById('encPass').value;

  hideMsg();

  if(!file) {
    showMsg('è¯·é€‰æ‹©è¦åŠ å¯†çš„å›¾ç‰‡æ–‡ä»¶', 'error');
    return;
  }

  if(!password || password.length < 6) {
    showMsg('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦', 'error');
    return;
  }

  if(!window.cryptoLoaded) {
    showMsg('åŠ å¯†åº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™é‡è¯•...', 'error');
    return;
  }

  showMsg('æ­£åœ¨åŠ å¯†ï¼Œè¯·ç¨å€™...', 'info');

  try {
    const data = await file.arrayBuffer();
    const salt = randomBytes(32);
    const nonce = randomBytes(24);
    const key = await deriveKey(password, salt);

    const cipher = new XChaCha20Poly1305(key);
    const encrypted = cipher.seal(nonce, new Uint8Array(data));

    const output = new Uint8Array(salt.length + nonce.length + encrypted.length);
    output.set(salt, 0);
    output.set(nonce, 32);
    output.set(encrypted, 56);

    const blob = new Blob([output], {type: 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = file.name + '.encrypted';
    a.click();
    URL.revokeObjectURL(url);

    showMsg('âœ“ åŠ å¯†æˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½', 'success');
  } catch(err) {
    showMsg('åŠ å¯†å¤±è´¥: ' + err.message, 'error');
    console.error(err);
  }
}

async function decryptFile() {
  const file = document.getElementById('decFile').files[0];
  const password = document.getElementById('decPass').value;

  hideMsg();

  if(!file) {
    showMsg('è¯·é€‰æ‹©è¦è§£å¯†çš„æ–‡ä»¶', 'error');
    return;
  }

  if(!password) {
    showMsg('è¯·è¾“å…¥å¯†ç ', 'error');
    return;
  }

  if(!window.cryptoLoaded) {
    showMsg('åŠ å¯†åº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™é‡è¯•...', 'error');
    return;
  }

  showMsg('æ­£åœ¨è§£å¯†ï¼Œè¯·ç¨å€™...', 'info');

  try {
    const data = await file.arrayBuffer();
    const dataArray = new Uint8Array(data);

    if(dataArray.length < 56) {
      throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
    }

    const salt = dataArray.slice(0, 32);
    const nonce = dataArray.slice(32, 56);
    const encrypted = dataArray.slice(56);

    const key = await deriveKey(password, salt);
    const cipher = new XChaCha20Poly1305(key);

    const decrypted = cipher.open(nonce, encrypted);

    if(!decrypted) {
      throw new Error('å¯†ç é”™è¯¯æˆ–æ–‡ä»¶å·²æŸå');
    }

    let filename = file.name;
    if(filename.endsWith('.encrypted')) {
      filename = filename.slice(0, -10);
    } else {
      filename = 'decrypted_' + filename;
    }

    const blob = new Blob([decrypted], {type: 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);

    showMsg('âœ“ è§£å¯†æˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½', 'success');
  } catch(err) {
    showMsg('è§£å¯†å¤±è´¥: ' + err.message, 'error');
    console.error(err);
  }
}
</script>
</body>
</html>
