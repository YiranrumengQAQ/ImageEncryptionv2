<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ç‰‡åŠ å¯†è§£å¯†å·¥å…· Â· Picocryptæ ·å¼</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family:'Segoe UI',Tahoma,sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #f6faff 100%);
      color: #0d3879;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .container {
      max-width:1200px;
      width:100%;
      background:#fff;
      box-shadow:0 8px 32px rgba(6,122,253,0.15);
      border-radius:20px;
      padding:40px 36px;
    }
    h1 {
      text-align:center;
      color:#067afd;
      font-size:2em;
      margin:0 0 8px 0;
      letter-spacing:0.5px;
    }
    .subtitle {
      text-align:center;
      color:#5a8cc7;
      font-size:0.95em;
      margin:0 0 32px 0;
    }
    .tab-buttons {
      display:flex;
      gap:10px;
      margin-bottom:28px;
    }
    .tab-btn {
      flex:1;
      padding:14px;
      border:none;
      background:#e3f2fd;
      color:#067afd;
      font-weight:600;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s;
      font-size:1em;
    }
    .tab-btn.active {
      background:linear-gradient(135deg, #067afd 0%, #0561d4 100%);
      color:#fff;
      box-shadow:0 4px 12px rgba(6,122,253,0.4);
      transform:translateY(-2px);
    }
    .tab-btn:hover:not(.active) {
      background:#cce7ff;
      transform:translateY(-1px);
    }
    .tab-content {
      display:none;
    }
    .tab-content.active {
      display:block;
    }
    
    /* ä¸‰æ å¸ƒå±€ */
    .content-wrapper {
      display:grid;
      grid-template-columns:300px 1fr 1fr;
      gap:24px;
      margin-bottom:20px;
    }
    
    /* å·¦ä¾§è¡¨å•åŒºåŸŸ */
    .form-section {
      display:flex;
      flex-direction:column;
    }
    
    .form-group {
      margin-bottom:18px;
    }
    label {
      display:block;
      margin-bottom:8px;
      color:#0d3879;
      font-weight:600;
      font-size:0.9em;
    }
    input[type="file"], input[type="password"], input[type="text"] {
      width:100%;
      padding:12px 14px;
      border:2px solid #d7e8ff;
      border-radius:10px;
      font-size:0.9em;
      background:#f9fcff;
      transition:all 0.3s;
      color:#0d3879;
    }
    input[type="file"]:focus, input[type="password"]:focus, input[type="text"]:focus {
      outline:none;
      border-color:#067afd;
      background:#fff;
      box-shadow:0 0 0 3px rgba(6,122,253,0.1);
    }
    input[type="password"]::placeholder, input[type="text"]::placeholder {
      color:#9ec5ed;
    }
    
    /* æŒ‰é’®ç»„ */
    .button-group {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:auto;
    }
    
    .btn {
      width:100%;
      padding:14px;
      border:none;
      color:#fff;
      font-weight:700;
      font-size:0.95em;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s;
      letter-spacing:0.5px;
    }
    .btn-primary {
      background:linear-gradient(135deg, #067afd 0%, #0561d4 100%);
      box-shadow:0 4px 12px rgba(6,122,253,0.3);
    }
    .btn-primary:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(6,122,253,0.4);
    }
    .btn-success {
      background:linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      box-shadow:0 4px 12px rgba(76,175,80,0.3);
    }
    .btn-success:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(76,175,80,0.4);
    }
    .btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .btn:active:not(:disabled) {
      transform:translateY(0);
    }
    
    /* é¢„è§ˆåŒºåŸŸ */
    .preview-section {
      display:flex;
      flex-direction:column;
    }
    .preview-label {
      margin-bottom:8px;
      color:#0d3879;
      font-weight:600;
      font-size:0.9em;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .preview-container {
      flex:1;
      border:2px dashed #d7e8ff;
      border-radius:10px;
      background:#f9fcff;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:300px;
      position:relative;
      overflow:hidden;
      transition:all 0.3s;
    }
    .preview-container.has-image {
      border-style:solid;
      border-color:#067afd;
      background:#fff;
    }
    .preview-placeholder {
      text-align:center;
      color:#9ec5ed;
      font-size:0.85em;
      padding:20px;
    }
    .preview-placeholder svg {
      width:64px;
      height:64px;
      margin-bottom:12px;
      opacity:0.3;
    }
    .preview-image {
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      display:none;
    }
    .preview-image.show {
      display:block;
    }
    
    /* åŠ å¯†çŠ¶æ€æ ‡è®° */
    .encrypted-badge {
      position:absolute;
      top:12px;
      right:12px;
      background:linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color:#fff;
      padding:6px 14px;
      border-radius:20px;
      font-size:0.75em;
      font-weight:700;
      box-shadow:0 2px 8px rgba(255,107,107,0.4);
      display:none;
      animation:pulse 2s infinite;
    }
    .encrypted-badge.show {
      display:block;
    }
    @keyframes pulse {
      0%, 100% { transform:scale(1); }
      50% { transform:scale(1.05); }
    }
    
    /* åŠ å¯†çŠ¶æ€é®ç½© */
    .encrypted-overlay {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      backdrop-filter:blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      color:#fff;
    }
    .encrypted-overlay.show {
      display:flex;
    }
    .encrypted-overlay svg {
      width:80px;
      height:80px;
      margin-bottom:16px;
      animation:float 3s ease-in-out infinite;
    }
    .encrypted-overlay p {
      font-size:1em;
      font-weight:600;
      margin:0;
    }
    @keyframes float {
      0%, 100% { transform:translateY(0); }
      50% { transform:translateY(-10px); }
    }
    
    .success-badge {
      position:absolute;
      top:12px;
      right:12px;
      background:linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color:#fff;
      padding:6px 14px;
      border-radius:20px;
      font-size:0.75em;
      font-weight:700;
      box-shadow:0 2px 8px rgba(76,175,80,0.4);
      display:none;
    }
    .success-badge.show {
      display:block;
    }
    
    .msg {
      margin-top:20px;
      padding:16px;
      border-radius:10px;
      font-size:0.95em;
      display:none;
      animation:slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity:0; transform:translateY(-10px); }
      to { opacity:1; transform:translateY(0); }
    }
    .msg.show {
      display:block;
    }
    .msg.success {
      background:#e8f5e9;
      color:#2e7d32;
      border-left:4px solid #4caf50;
    }
    .msg.error {
      background:#ffebee;
      color:#c62828;
      border-left:4px solid #f44336;
    }
    .msg.info {
      background:#e3f2fd;
      color:#1565c0;
      border-left:4px solid #2196f3;
    }
    .footer {
      text-align:center;
      margin-top:28px;
      color:#7ba3d1;
      font-size:0.9em;
      padding-top:20px;
      border-top:1px solid #e3f2fd;
    }
    
    @media (max-width:1024px){
      .content-wrapper {
        grid-template-columns:1fr 1fr;
      }
      .form-section {
        grid-column:1 / -1;
      }
    }
    
    @media (max-width:768px){
      .content-wrapper {
        grid-template-columns:1fr;
      }
      .container {
        padding:32px 24px;
      }
      h1 {
        font-size:1.6em;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ” å›¾ç‰‡åŠ å¯†å·¥å…·</h1>
  <p class="subtitle">åŸºäºXChaCha20-Poly1305åŠ å¯†ç®—æ³• Â· æœ¬åœ°åŠ å¯† Â· å®‰å…¨å¯é </p>

  <div class="tab-buttons">
    <button class="tab-btn active" onclick="switchTab('encrypt')">ğŸ”’ åŠ å¯†å›¾ç‰‡</button>
    <button class="tab-btn" onclick="switchTab('decrypt')">ğŸ”“ è§£å¯†å›¾ç‰‡</button>
  </div>

  <!-- åŠ å¯†æ ‡ç­¾é¡µ -->
  <div id="encrypt-tab" class="tab-content active">
    <div class="content-wrapper">
      <!-- å·¦ä¾§è¡¨å• -->
      <div class="form-section">
        <div class="form-group">
          <label>ğŸ“ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
          <input type="file" id="encFile" accept="image/*" onchange="previewEncryptImage(this)">
        </div>
        <div class="form-group">
          <label>ğŸ”‘ è®¾ç½®å¯†ç </label>
          <input type="password" id="encPass" placeholder="è¯·è¾“å…¥å¼ºå¯†ç (è‡³å°‘6ä½)">
        </div>
        <div class="button-group">
          <button class="btn btn-primary" onclick="encryptFile()">ğŸ”’ åŠ å¯†å›¾ç‰‡</button>
          <button class="btn btn-success" id="encDownloadBtn" onclick="downloadEncrypted()" disabled>ğŸ“¥ ä¸‹è½½åŠ å¯†æ–‡ä»¶</button>
        </div>
      </div>
      
      <!-- åŸå›¾é¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-label">
          <span>ğŸ“· åŸå§‹å›¾ç‰‡</span>
        </div>
        <div class="preview-container" id="encPreview">
          <div class="preview-placeholder">
            <svg fill="#9ec5ed" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            <p>é€‰æ‹©å›¾ç‰‡åæ˜¾ç¤ºé¢„è§ˆ</p>
          </div>
          <img id="encPreviewImg" class="preview-image" alt="åŸå›¾é¢„è§ˆ">
        </div>
      </div>
      
      <!-- å¤„ç†åé¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-label">
          <span>ğŸ” å¤„ç†åæ•ˆæœ</span>
        </div>
        <div class="preview-container" id="encResultPreview">
          <div class="preview-placeholder">
            <svg fill="#9ec5ed" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <p>åŠ å¯†æˆåŠŸåæ˜¾ç¤ºæ•ˆæœ</p>
          </div>
          <div class="encrypted-overlay" id="encResultOverlay">
            <svg fill="#fff" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <p>ğŸ” å·²åŠ å¯†</p>
            <p style="font-size:0.8em;margin-top:8px;opacity:0.8;">å†…å®¹å·²å®‰å…¨åŠ å¯†ä¿æŠ¤</p>
          </div>
          <div class="encrypted-badge" id="encResultBadge">ğŸ” å·²åŠ å¯†</div>
        </div>
      </div>
    </div>
  </div>

  <!-- è§£å¯†æ ‡ç­¾é¡µ -->
  <div id="decrypt-tab" class="tab-content">
    <div class="content-wrapper">
      <!-- å·¦ä¾§è¡¨å• -->
      <div class="form-section">
        <div class="form-group">
          <label>ğŸ“ é€‰æ‹©åŠ å¯†æ–‡ä»¶</label>
          <input type="file" id="decFile" onchange="previewDecryptFile(this)">
        </div>
        <div class="form-group">
          <label>ğŸ”‘ è¾“å…¥å¯†ç </label>
          <input type="password" id="decPass" placeholder="è¯·è¾“å…¥åŠ å¯†æ—¶çš„å¯†ç ">
        </div>
        <div class="button-group">
          <button class="btn btn-primary" onclick="decryptFile()">ğŸ”“ è§£å¯†å›¾ç‰‡</button>
          <button class="btn btn-success" id="decDownloadBtn" onclick="downloadDecrypted()" disabled>ğŸ“¥ ä¸‹è½½è§£å¯†æ–‡ä»¶</button>
        </div>
      </div>
      
      <!-- åŸå§‹ï¼ˆåŠ å¯†ï¼‰æ–‡ä»¶é¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-label">
          <span>ğŸ”’ åŸå§‹æ–‡ä»¶</span>
        </div>
        <div class="preview-container" id="decPreview">
          <div class="preview-placeholder">
            <svg fill="#9ec5ed" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <p>é€‰æ‹©æ–‡ä»¶åæ˜¾ç¤ºçŠ¶æ€</p>
          </div>
          <div class="encrypted-overlay" id="encryptedOverlay">
            <svg fill="#fff" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <p>ğŸ” åŠ å¯†æ–‡ä»¶</p>
            <p style="font-size:0.8em;margin-top:8px;opacity:0.8;">è¾“å…¥å¯†ç åå¯è§£å¯†æŸ¥çœ‹</p>
          </div>
          <div class="encrypted-badge" id="encryptedBadge">ğŸ” å·²åŠ å¯†</div>
        </div>
      </div>
      
      <!-- å¤„ç†åï¼ˆè§£å¯†ï¼‰é¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-label">
          <span>âœ… å¤„ç†åæ•ˆæœ</span>
        </div>
        <div class="preview-container" id="decResultPreview">
          <div class="preview-placeholder">
            <svg fill="#9ec5ed" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            <p>è§£å¯†æˆåŠŸåæ˜¾ç¤ºå›¾ç‰‡</p>
          </div>
          <img id="decResultImg" class="preview-image" alt="è§£å¯†åçš„å›¾ç‰‡">
          <div class="success-badge" id="decResultBadge">âœ… è§£å¯†æˆåŠŸ</div>
        </div>
      </div>
    </div>
  </div>

  <div id="msg" class="msg"></div>

  <div class="footer">
    ğŸ›¡ï¸ å®‰å…¨åŠ å¯† Â· ğŸ’» æœ¬åœ°å¤„ç† Â· ğŸš« æ•°æ®ä¸ä¸Šä¼  Â· âš¡ å¿«é€Ÿä¾¿æ·
  </div>
</div>

<script type="module">
import { XChaCha20Poly1305 } from 'https://cdn.jsdelivr.net/npm/@stablelib/xchacha20poly1305@1.0.1/+esm';
import { randomBytes } from 'https://cdn.jsdelivr.net/npm/@stablelib/random@1.0.2/+esm';

window.XChaCha20Poly1305 = XChaCha20Poly1305;
window.randomBytes = randomBytes;
window.cryptoLoaded = true;
</script>

<script>
// å…¨å±€å˜é‡å­˜å‚¨åŠ å¯†/è§£å¯†åçš„æ•°æ®
let encryptedData = null;
let decryptedData = null;
let currentFileName = '';

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

  if(tab === 'encrypt') {
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('encrypt-tab').classList.add('active');
  } else {
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('decrypt-tab').classList.add('active');
  }
  hideMsg();
  resetPreviews();
}

function resetPreviews() {
  // é‡ç½®åŠ å¯†é¡µé¢
  document.getElementById('encPreview').classList.remove('has-image');
  document.getElementById('encPreviewImg').classList.remove('show');
  document.getElementById('encPreviewImg').src = '';
  document.getElementById('encResultPreview').classList.remove('has-image');
  document.getElementById('encResultOverlay').classList.remove('show');
  document.getElementById('encResultBadge').classList.remove('show');
  document.getElementById('encDownloadBtn').disabled = true;
  encryptedData = null;
  
  // é‡ç½®è§£å¯†é¡µé¢
  document.getElementById('decPreview').classList.remove('has-image');
  document.getElementById('encryptedOverlay').classList.remove('show');
  document.getElementById('encryptedBadge').classList.remove('show');
  document.getElementById('decResultPreview').classList.remove('has-image');
  document.getElementById('decResultImg').classList.remove('show');
  document.getElementById('decResultImg').src = '';
  document.getElementById('decResultBadge').classList.remove('show');
  document.getElementById('decDownloadBtn').disabled = true;
  decryptedData = null;
}

function previewEncryptImage(input) {
  const file = input.files[0];
  if(file && file.type.startsWith('image/')) {
    currentFileName = file.name;
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById('encPreviewImg');
      const container = document.getElementById('encPreview');
      img.src = e.target.result;
      img.classList.add('show');
      container.classList.add('has-image');
      
      // é‡ç½®ç»“æœé¢„è§ˆ
      document.getElementById('encResultPreview').classList.remove('has-image');
      document.getElementById('encResultOverlay').classList.remove('show');
      document.getElementById('encResultBadge').classList.remove('show');
      document.getElementById('encDownloadBtn').disabled = true;
      encryptedData = null;
    };
    reader.readAsDataURL(file);
  }
}

function previewDecryptFile(input) {
  const file = input.files[0];
  if(file) {
    currentFileName = file.name;
    const container = document.getElementById('decPreview');
    const overlay = document.getElementById('encryptedOverlay');
    const badge = document.getElementById('encryptedBadge');
    
    // é‡ç½®ç»“æœé¢„è§ˆ
    document.getElementById('decResultPreview').classList.remove('has-image');
    document.getElementById('decResultImg').classList.remove('show');
    document.getElementById('decResultImg').src = '';
    document.getElementById('decResultBadge').classList.remove('show');
    document.getElementById('decDownloadBtn').disabled = true;
    decryptedData = null;
    
    if(file.name.endsWith('.encrypted')) {
      container.classList.add('has-image');
      overlay.classList.add('show');
      badge.classList.add('show');
    } else {
      checkIfEncrypted(file).then(isEncrypted => {
        if(isEncrypted) {
          container.classList.add('has-image');
          overlay.classList.add('show');
          badge.classList.add('show');
        }
      });
    }
  }
}

async function checkIfEncrypted(file) {
  try {
    const data = await file.slice(0, 100).arrayBuffer();
    const dataArray = new Uint8Array(data);
    return file.size >= 56 && dataArray.length >= 56;
  } catch(e) {
    return false;
  }
}

function showMsg(text, type) {
  const msg = document.getElementById('msg');
  msg.textContent = text;
  msg.className = 'msg show ' + type;
}

function hideMsg() {
  document.getElementById('msg').className = 'msg';
}

async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    enc.encode(password),
    'PBKDF2',
    false,
    ['deriveBits']
  );

  const bits = await crypto.subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: salt,
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    256
  );

  return new Uint8Array(bits);
}

async function encryptFile() {
  const file = document.getElementById('encFile').files[0];
  const password = document.getElementById('encPass').value;

  hideMsg();

  if(!file) {
    showMsg('âŒ è¯·é€‰æ‹©è¦åŠ å¯†çš„å›¾ç‰‡æ–‡ä»¶', 'error');
    return;
  }

  if(!password || password.length < 6) {
    showMsg('âŒ å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦', 'error');
    return;
  }

  if(!window.cryptoLoaded) {
    showMsg('â³ åŠ å¯†åº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™é‡è¯•...', 'error');
    return;
  }

  showMsg('â³ æ­£åœ¨åŠ å¯†ï¼Œè¯·ç¨å€™...', 'info');

  try {
    const data = await file.arrayBuffer();
    const salt = randomBytes(32);
    const nonce = randomBytes(24);
    const key = await deriveKey(password, salt);

    const cipher = new XChaCha20Poly1305(key);
    const encrypted = cipher.seal(nonce, new Uint8Array(data));

    const output = new Uint8Array(salt.length + nonce.length + encrypted.length);
    output.set(salt, 0);
    output.set(nonce, 32);
    output.set(encrypted, 56);

    // ä¿å­˜åŠ å¯†æ•°æ®
    encryptedData = output;
    currentFileName = file.name;

    // æ˜¾ç¤ºåŠ å¯†åæ•ˆæœ
    const resultContainer = document.getElementById('encResultPreview');
    const resultOverlay = document.getElementById('encResultOverlay');
    const resultBadge = document.getElementById('encResultBadge');
    resultContainer.classList.add('has-image');
    resultOverlay.classList.add('show');
    resultBadge.classList.add('show');

    // å¯ç”¨ä¸‹è½½æŒ‰é’®
    document.getElementById('encDownloadBtn').disabled = false;

    showMsg('âœ… åŠ å¯†æˆåŠŸï¼å¯ä»¥ç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜æ–‡ä»¶', 'success');
  } catch(err) {
    showMsg('âŒ åŠ å¯†å¤±è´¥: ' + err.message, 'error');
    console.error(err);
  }
}

function downloadEncrypted() {
  if(!encryptedData) {
    showMsg('âŒ æ²¡æœ‰å¯ä¸‹è½½çš„åŠ å¯†æ–‡ä»¶', 'error');
    return;
  }

  const blob = new Blob([encryptedData], {type: 'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = currentFileName + '.encrypted';
  a.click();
  URL.revokeObjectURL(url);

  showMsg('âœ… æ–‡ä»¶å·²ä¸‹è½½ï¼', 'success');
}

async function decryptFile() {
  const file = document.getElementById('decFile').files[0];
  const password = document.getElementById('decPass').value;

  hideMsg();

  if(!file) {
    showMsg('âŒ è¯·é€‰æ‹©è¦è§£å¯†çš„æ–‡ä»¶', 'error');
    return;
  }

  if(!password) {
    showMsg('âŒ è¯·è¾“å…¥å¯†ç ', 'error');
    return;
  }

  if(!window.cryptoLoaded) {
    showMsg('â³ åŠ å¯†åº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™é‡è¯•...', 'error');
    return;
  }

  showMsg('â³ æ­£åœ¨è§£å¯†ï¼Œè¯·ç¨å€™...', 'info');

  try {
    const data = await file.arrayBuffer();
    const dataArray = new Uint8Array(data);

    if(dataArray.length < 56) {
      throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
    }

    const salt = dataArray.slice(0, 32);
    const nonce = dataArray.slice(32, 56);
    const encrypted = dataArray.slice(56);

    const key = await deriveKey(password, salt);
    const cipher = new XChaCha20Poly1305(key);

    const decrypted = cipher.open(nonce, encrypted);

    if(!decrypted) {
      throw new Error('å¯†ç é”™è¯¯æˆ–æ–‡ä»¶å·²æŸå');
    }

    // ä¿å­˜è§£å¯†æ•°æ®
    decryptedData = decrypted;
    currentFileName = file.name;

    // æ˜¾ç¤ºè§£å¯†åé¢„è§ˆï¼ˆå¦‚æœæ˜¯å›¾ç‰‡ï¼‰
    let filename = file.name;
    if(filename.endsWith('.encrypted')) {
      filename = filename.slice(0, -10);
    }

    if(filename.match(/.(jpg|jpeg|png|gif|webp|bmp)$/i)) {
      const imgUrl = URL.createObjectURL(new Blob([decrypted], {type: 'image/png'}));
      const resultImg = document.getElementById('decResultImg');
      const resultContainer = document.getElementById('decResultPreview');
      const resultBadge = document.getElementById('decResultBadge');
      
      resultImg.src = imgUrl;
      resultImg.classList.add('show');
      resultContainer.classList.add('has-image');
      resultBadge.classList.add('show');
    }

    // å¯ç”¨ä¸‹è½½æŒ‰é’®
    document.getElementById('decDownloadBtn').disabled = false;

    showMsg('âœ… è§£å¯†æˆåŠŸï¼å¯ä»¥ç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜æ–‡ä»¶', 'success');
  } catch(err) {
    showMsg('âŒ è§£å¯†å¤±è´¥: ' + err.message, 'error');
    console.error(err);
  }
}

function downloadDecrypted() {
  if(!decryptedData) {
    showMsg('âŒ æ²¡æœ‰å¯ä¸‹è½½çš„è§£å¯†æ–‡ä»¶', 'error');
    return;
  }

  let filename = currentFileName;
  if(filename.endsWith('.encrypted')) {
    filename = filename.slice(0, -10);
  } else {
    filename = 'decrypted_' + filename;
  }

  const blob = new Blob([decryptedData], {type: 'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);

  showMsg('âœ… æ–‡ä»¶å·²ä¸‹è½½ï¼', 'success');
}

window.switchTab = switchTab;
window.encryptFile = encryptFile;
window.decryptFile = decryptFile;
window.downloadEncrypted = downloadEncrypted;
window.downloadDecrypted = downloadDecrypted;
window.previewEncryptImage = previewEncryptImage;
window.previewDecryptFile = previewDecryptFile;
</script>
</body>
</html>
